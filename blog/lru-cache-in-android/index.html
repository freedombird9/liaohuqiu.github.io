<!DOCTYPE html>
<html lang="en">

<head>
<meta charset='utf-8' />
<meta http-equiv="X-UA-Compatible" content="chrome=1" />

<meta name="author" content="srain / 廖祜秋 / 无朽 / liaohuqiu" />
<meta name="description" content="The blog of 廖祜秋 / 无朽 / liaohuqiu" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

<link rel="stylesheet" type="text/css" media="screen" href="/assets/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" media="screen" href="/assets/css/base.css?v=3">


<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>

<title>LRU cache in Android |  Yet Another Summer Rain</title>
</head>

<body>

<!-- HEADER -->
<div id="header_wrap" class="outer">
    <header class="inner">
        <h1 id="site_title"><a href="/">Srain</a></h1>
    </header>
</div>

<!-- MAIN CONTENT -->
<div class='post'>
    <div id="main_content_wrap" class="outer">
        <div class="md-body main-content inner wide">
            <h2> LRU cache in Android </h2>
            <p> 23 Dec 2013 </p>
            <hr>
            <h4>LRU cache</h4>

<p>LRU cache is very convinient to manager a list of data which has a limit space requirement.</p>

<p>LRU cache managers an object list. Each time a valued is accessed, it is moved to the head of the list. When a value is put into the cache, the value at the end of the list may be evicted.</p>

<p>There are two kinds of LruCache in Android: <code>LruCache</code> and <code>DiskLruCache</code>, the fisrt can be used to manager an set of objects, the later can be used to manager files.</p>

<p>A senoar that a LruCache can be used is to manager the quota of disk cache and memory cache when loading a network image.</p>

<p>After an image is loaded from the remote server, commonly it will be write to disk for further use. When the image is required to display in the <code>ImageView</code> we will decode the bitmap data from this file. The decoding operation is Cpu-time comsumed. To avoid the same image to be decode for multiple time for the bitmap data, the bitmap data will be cached in the memory after the first time it is decoded.</p>

<p>But the memory and the strage space is very limited, we can not take too much of that. Each time a file is writen to storage of a bitmap data is cached into memory, we must check the total size of the cached data and remove the eldest objects if nessery.</p>

<p>Here, the <code>LRU Cache</code> will make things easy.</p>

<h4>LruCache</h4>

<p><code>LruCache</code> is in the <code>support V4</code> package. It is very simple.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">LRU cache
    |
    +- -map, LinkedHashmap
    |
    +- +put(K key, V value)
    |
    +- +get(K key)
    |
    +- -sizeOf(K key, V value)
    |
    +- -entryRemoved(K key,V value)
    |
    +- -create(K key)
</code></pre></div>
<p>The <code>LruCache</code> has a <code>LinkedHashmap</code> inside, which is constructed by</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text"> public LinkedHashMap(int initialCapacity, float loadFactor, boolean accessOrder)
</code></pre></div>
<p>The third parameter allow the <code>LinkedHashmap</code> to put the element to the head of the linked list after accessed, both by <code>get</code> and <code>set</code>.</p>

<ol>
<li><code>sizeOf(K key, V value)</code> method return the size of each count which will be used to calculate the size of the whole size.
&gt; The default implementions returns 1, which make the LRU cache only manager a limit amount of objects.</li>
<li>The method `put(K key, V value) cache the value to the cache and check the size.</li>
<li><p>The method <code>get(K key)</code> will return the value for the key if it is exist in the cache. </p>

<p>When a value is returned, it will move to the head of the queue, this is grantened by the <code>LinkedHashmap</code>;</p>

<p>If the value is not exist, method <code>create(K key)</code> will be called to create the value. If a the value is created, it will be put into cache and the limit size will be checked. This will make the code simple.</p></li>
<li><p><code>entryRemoved</code> will be call when an object is removed when the new value conrespong value of this key is put into cache
or the total size of the cache has exceed the limit.</p></li>
</ol>

<p>We can make a limit cache to store BitmapData:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">int cacheSizeInKB = 1024 * 10; // 10MB
LruCache&lt;String, Bitmap&gt; cache = new LruCache&lt;String, Bitmap&gt;(cacheSizeInKB) {

    @Override
    protected void entryRemoved(boolean evicted, String key, Bitmap oldValue, Bitmap newValue) {
    }

    /**
     * Measure item size in kilobytes rather than units which is more practical for a bitmap cache
     */
    @Override
    protected int sizeOf(String key, Bitmap value) {
        final int bitmapSize =  value.getByteCount() / 1024;
        return bitmapSize == 0 ? 1 : bitmapSize;
    }
};
</code></pre></div>
<hr>

<h4>DiskLurCache</h4>

<p>The <code>DiskLruCache</code> has an implementaion in <a href="https://android.googlesource.com/platform/libcore/+/android-4.1.1_r1/luni/src/main/java/libcore/io/DiskLruCache.java">JB source</a>.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">DiskLruCache
    |
    +- +get()   // return a snapshot which is realted to the key.
    |
    +- +edit()  // return the default `Editor` related the an `Entry` which is related to the key.
</code></pre></div>
<p>Like <code>LruCache</code>, it has a <code>LinkedHashmap</code> inside to manage the access order of the cached files. </p>

<p>There are some classes where are used to managed the info of the cached files:</p>

<ul>
<li>  Editor</li>
</ul>
<div class="highlight"><pre><code class="text language-text" data-lang="text">1.  An `Editor` providers some operations of file: create, save, read;
</code></pre></div>
<ul>
<li>  Snapshot</li>
</ul>
<div class="highlight"><pre><code class="text language-text" data-lang="text">1. A `Snapshot` is related to a `key`, 
</code></pre></div>
<ul>
<li>  Entry</li>
</ul>
<div class="highlight"><pre><code class="text language-text" data-lang="text">1. `Entry` store the 
</code></pre></div>
<hr>

<p>There is a class <code>Snapshot</code> which is used to describe the cached files, each <code>Snapshot</code> has one or more <code>Editor</code>, which is related the operataion with the cached file. That is to say,, a cache key in <code>DiskLruCache</code> is related to one or more file.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">Snapshot
  |
  +- - InputStream[] ins

Editor
  |
  +-
  +
</code></pre></div>
<p>Unlike <code>LruCache</code> a key may associate one or more file
There is an inner class <code>Entry</code> to describe the cached files:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">Entry
 |  
 +- -long[] lengths
 +- -String key
 +- +setLengths(String[] strings)
 +- +getLengths()
</code></pre></div>
            <hr>
            <div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'srain'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        </div>
    </div>
</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
try
{
ga('create', 'UA-43024238-1', 'liaohuqiu.net');
ga('send', 'pageview');
} catch(err) {
    console.log(err);
}
</script>

</body>
</html>
